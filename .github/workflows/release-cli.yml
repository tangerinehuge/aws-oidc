name: release-cli

on:
  release:
    types: [published]

jobs:
  release-please:
    runs-on: ARM64
    steps:
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_ACTIONS_HELPER_APP_ID }}
          private-key: ${{ secrets.GH_ACTIONS_HELPER_PK }}
          owner: ${{ github.repository_owner }}
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v7
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}

      - name: Install gh CLI
        uses: jaxxstorm/action-install-gh-release@v2
        with:
          repo: cli/cli

      - name: Update recipe checksums
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"

          gh release download "v${VERSION}" --repo "${{ github.repository }}" --pattern "*_checksums.txt" --dir /tmp

          python3 - "${VERSION}" <<'PYEOF'
          import re, sys

          version = sys.argv[1]
          checksums = {}
          with open(f"/tmp/aws-oidc_{version}_checksums.txt") as f:
              for line in f:
                  parts = line.strip().split("  ")
                  if len(parts) != 2:
                      continue
                  sha, name = parts
                  for platform in ("linux_amd64", "linux_arm64", "darwin_arm64", "darwin_amd64"):
                      if platform in name:
                          checksums[platform] = sha

          with open("recipe/recipe.yaml") as f:
              content = f.read()

          for platform, sha in checksums.items():
              content = re.sub(
                  rf"({platform}\.tar\.gz\n\s+sha256: )\w+",
                  rf"\g<1>{sha}",
                  content,
              )

          with open("recipe/recipe.yaml", "w") as f:
              f.write(content)
          PYEOF

          git checkout main
          git pull origin main
          git add recipe/recipe.yaml
          if ! git diff --cached --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git commit -m "chore: update recipe checksums for v${VERSION}"
            git push origin main
          fi